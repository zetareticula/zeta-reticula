apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: master-service-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: master-service
  policyTypes:
  - Ingress
  - Egress
  
  # Allow incoming traffic only from:
  # - Other pods in the same namespace with the label 'app=internal'
  # - The monitoring namespace for metrics scraping
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: internal
    - namespaceSelector:
        matchLabels:
          name: monitoring
      podSelector:
        matchExpressions:
        - {key: app.kubernetes.io/name, operator: In, values: [prometheus]}
    ports:
    - protocol: TCP
      port: 50051
    - protocol: TCP
      port: 9090  # metrics port

  # Allow outgoing traffic only to:
  # - kube-dns for DNS resolution
  # - Other internal services in the same namespace
  # - External dependencies (e.g., databases, caches)
  egress:
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  - to:
    - podSelector:
        matchLabels:
          app: internal-service
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  
  # Allow outbound HTTPS traffic for external services
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 6379  # Redis
    - protocol: TCP
      port: 9092  # Kafka
    - protocol: TCP
      port: 2181  # Zookeeper
